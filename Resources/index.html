<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">

	<title>GTasktic</title>

	<link type="text/css" rel="stylesheet" href="css/wunderlist.css">
	<link type="text/css" rel="stylesheet" href="css/dialogs.css">
	<link type="text/css" rel="stylesheet" href="css/ui.notify.css">
	
	<script src="lib/json2.js" type="text/javascript" charset="utf-8"></script>
  	<script type="text/javascript" src="lib/jquery-1.6.min.js"></script>
	<script src="lib/jquery.tmpl.js" type="text/javascript" charset="utf-8"></script>
	<script src="lib/jsutil5.js" type="text/javascript" charset="utf-8"></script>

	<!-- Loading external libraries -->
	<script type="text/javascript" src="lib/jquery.ui.1.8.10.min.js"></script>
	<script type="text/javascript" src="lib/jquery.async.js"></script>
	<script type="text/javascript" src="lib/shortcuts.js"></script>
	<script type="text/javascript" src="lib/encoder.js"></script>

	<script src="lib/dateformat.js" type="text/javascript" charset="utf-8"></script>
	<script src="lib/jquery.notify.min.js" type="text/javascript" charset="utf-8"></script>
	
	<script src="app/spine.js" type="text/javascript" charset="utf-8"></script>
	<script src="app/spine.model.sqlite.js" type="text/javascript" charset="utf-8"></script>
	<script src="app/task.js" type="text/javascript" charset="utf-8"></script>
	<script src="app/sync.js" type="text/javascript" charset="utf-8"></script>
	<script src="app/application.js" type="text/javascript" charset="utf-8"></script>
	<script src="app/application_setting.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="app/hotkeys.js" charset="utf-8"></script>

	<!-- fullcalendar shizzle -->
	<link rel='stylesheet' type='text/css' href='fullcalendar/fullcalendar.css' />
	<script type='text/javascript' src='fullcalendar/fullcalendar.js'></script>

	<script type="text/x-jquery-tmpl" id="taskTemplate">
		<div class="item {{if done}}done{{/if}}">
		  <div class="view" title="Double click to edit...">
		    <input type="checkbox" {{if done}}checked="checked"{{/if}}> 
		    <span>${name}</span>{{if note}}<img src="famfamicons/note.png" class="noteimage" />{{/if}} <span class="duedate">${duedate}</span> 
		    <input type="hidden" class="id" value="${id}" />
		    <a class="destroy"></a>
		  </div>
		  
		  <div class="edit">
  			<form class="edittask_form">
	  			<table class="editform">
	  				<tr>
	  					<td class="header"><input type="checkbox" {{if done}}checked="checked"{{/if}}></td>
	  					<td><input class="name" type="text" value="${name}"></td>
	  				</tr>
	  				<tr>
	  					<td class="header" style="vertical-align: top;"><img src="famfamicons/note.png" /></td>
	  					<td><textarea class="note" rows="2" placeholder="Add a note here" >${note}</textarea></td>
	  				</tr>
	  				<tr>
	  					<td class="header last"><img src="famfamicons/calendar.png" /></td>
	  					<td class="last"><input type="text" class="datepicker" placeholder="Due date" value="${duedate}" /><input class="editsave" type="submit" value="Save" /></td>
	  				</tr>
	  			</table>
  			</form>
		  </div>
		</div>
	</script>

	<script type="text/x-jquery-tmpl" id="listTemplate">
	  <div id="${id}" class="listdiv">
	  	  <div class="list_header">
	  	  	  <h1 class="title" style="">${name}</h1>
		      <div class="list_bar">
		      	<a class="deletelist"><img src="famfamicons/delete.png" height="14px"/></a>
		      	<a class="editlist"><img src="famfamicons/pencil.png" height="14px"/></a>
		      </div>
		      <div class="count listbutton" style="float: right;"><span class="countVal"></span> left</div>
	      </div>
	      
	      <div class="items roundedlist connectedsortable" id="${id}_actual"></div>
	      
      	  <footer>
      	  	<a class="clear listbutton" style="">Clear completed</a>
	        <a class="addtoggle listbutton">Add Tasks</a>
	        <div class="addinputs" style="display: inline-block;">
	        	<a class="doneadding listbutton">Done Adding</a>
				<form class="addform" style="display: inline-block"><input type="text" class="addtasks" placeholder="Add your task here and hit Return for entry" /></form>
	      	</div>
	      </footer>
      </div>
	</script>

	<link type="text/css" rel="stylesheet" href="css/app.css">

  	<script>
        Titanium.include("gtask.py");
	</script>

	<script>
		Task.fetch();
		Deletion.fetch();
		List.fetch();
		Key.fetch();
		
		Initialized.fetch();
		
		initializeApp();
		
		setting_url = "";
		
		window.last_opened = ""; //global variable keeping track of the last opened div
		window.cur = 0; //this is for the position of the selected task
		window.taskdict = {}
		
		//For notification
		function create( template, vars, opts ){
			return $container.notify("create", template, vars, opts);
		};
		
		//Initial page setup
		$(function() {
			$("#newtaskdate").datepicker({
				constrainInput: true,
				buttonImage: 'famfamicons/calendar.png',
				buttonImageOnly: true,
				buttonText: '',
				showOn: 'both',
				onSelect: function(dateText, inst) {
					if ($(this).parent().parent().find('.showdate').length == 1){
						$(this).parent().parent().find('.showdate').html(dateText);
					};
				}
			});
			
			//set auth link
			keys = Key.all();
			if (keys.length != 0) {
				setting_url = keys[0].url;
			}
			else {
				setting_url = create_link();
				Key.create({ url: setting_url });
			};
			$("#authlink").attr("href", setting_url)
			$container = $("#container").notify();
			
			$('#calendar').fullCalendar({
				events: function(start, end, callback) {
					
					//Calendar filling with events
			        dated_tasks = Task.select(function(item){ return item.duedate != undefined; })
			
					var calendar_input = [];
					$.each(dated_tasks, function(index, value) { calendar_input.push({ title: value.name, start: new Date(value.duedate) }) });
					
					callback(calendar_input);
			    },
			});
			
			//hide the calendar initially
			$("#calendarview").hide();
			
			//Keystrokes
			updateItems();
      		shortcut.add('up', prevItem);
      		shortcut.add('down', nextItem);
      		shortcut.add('enter', open_for_edit, {'disable_in_input':'true'});
      		shortcut.add('backspace', pressed_delete, {'disable_in_input':'true'});
      		shortcut.add('delete', pressed_delete, {'disable_in_input':'true'});
      		//shortcut.add('tab', make_child, {'disable_in_input':'true'});
      		
		});
		
		function rendering_cal() {
			//Calendar filling with events
			dated_tasks = Task.select(function(item){ return item.duedate != undefined; })
			
			var calendar_input = [];
			$.each(dated_tasks, function(index, value) { calendar_input.push({ title: value.name, start: new Date(value.duedate) }) });
			
			$("#calendar").fullCalendar("renderEvent", calendar_input, false);
		};
		
		function addlist_window() {
			$('#list_name').val("");
			$('#list_description').val("");
			$("#dialog_addlist").dialog({ modal: true, title: 'Add A New List', dialogClass: "adding" });
		};
		
		function add_list() {
			name = $('#list_name').val();
			description = $('#list_description').val();
			
			newlist = List.init( { name: name, description: description, time: ( new Date().getTime() ).toString(), synced: false } );
			
			newlist.save();
			
			window.App.render_new(newlist);
			$("#dialog_addlist").dialog("close");
		};
		
		function edit_list() {
			curr_list = List.find($("#dialog_addlist").data("id"));
			curr_list.name = $('#list_name').val();
			curr_list.description = $('#list_description').val();
			curr_list.time = ( new Date().getTime() ).toString();
			curr_list.save();
			
			$("#dialog_addlist").dialog("close");
		};
		
		function open_background_dialog() {
			$("#dialog_changebackground").dialog({ modal: true, title: 'Change Your Background' });
		};

		function getAsText(readFile) {
		        
		  var reader = new FileReader();
		  reader.onload = function(e) {
		  	  alert("here 2");
			  var bin = e.target.result;
			  // bin is the binaryString
		  	  alert(bin);
		  };
		  
		  // Read file into memory as UTF-16      
		  reader.readAsBinaryString(readFile, "UTF-16");

		  return reader;
		};

		function background_change() {
			
			var file = document.getElementById('background_file').files[0];
			alert(file);
			if(file){
			    getAsText(file);
			};
		};
		
		/*simple tab function*/
		function toggle( element_a, element_b, tab_a, tab_b ) {
			$(element_a).hide();
			$(element_b).show();
			$(tab_a).removeClass("active");
			$(tab_b).addClass("active");
			
			$("#calendar").fullCalendar( 'refetchEvents' );
			$("#calendar").fullCalendar( 'windowResize' );
		};
		
		//Check if the app has been initialized or not and then initialize it
		function initializeApp() {
			//Check if the app has being initialized
			if ( Initialized.all().length == 0) {
				//Delete all of the stuff before
				delete localStorage['Task'];
				
				setting_url = create_link();
				Key.create({ url: setting_url });
				
				//Set the version number 
				new_version = Version.init({ number: "0.2" });
				new_version.save();
				
				//set the intiialization flag
				set_init = Initialized.init({ flag: "true" } );
				set_init.save();
				
				//Create a list that represent the default list
				newlist = List.init( { name: "Your Todos", description: "", time: ( new Date().getTime() ).toString(), synced: false } );
				newlist.id = "@default";
				newlist.save();
				
				//Create a bunch of todos representing what people needs to do
				new_task = Task.init({name: "Click on settings and link your gtask account", time: ( new Date().getTime() ).toString(), done: false, order: Task.all().length + 1, synced: false, listid: "@default" });
				new_task_2 = Task.init({name: "Click on sync to get the tasks in your current google account", time: ( new Date().getTime() ).toString(), done: false, order: Task.all().length + 1, synced: false, listid: "@default" });
				new_task.save();
				new_task_2.save();
				
			};
		};
		
		//get all the div showing
		function show_all_div() {
			$(".listdiv").show();
			$(".filterselected").removeClass("filterselected");
	  		$("#allbutton").addClass("filterselected");
		};
	
		window.onerror = function myErrorHandler(errorMsg, url, lineNumber) {
			total_message = errorMsg + " " + url + " " + lineNumber;
			
			submit_error_form( total_message )
		};
		
	</script>

</head>

<body id="theapp">

	<div id="bghelp" style="background-image: url('linen.gif'); background-attachment: fixed; background-origin: initial; background-clip: initial; background-color: rgb(0, 0, 0); display: block; background-position: bottom center; background-repeat: no-repeat no-repeat; top: 40px;"></div>
	
	<header id="title">
		<div id="buttonbar">
			<a id="listtab" class="filter roundedleft active" onclick="toggle('#calendarview', '#views', '#calendartab','#listtab')"><img src="images/align_just_icon_16.png" height="11px" style="vertical-align: top; margin-right: 2px;" /> Your Lists</a>
			<a id="calendartab" class="roundedright filter" onclick="toggle('#views', '#calendarview', '#listtab', '#calendartab')"><img src="images/calendar_1_icon_16.png" height="11px" style="vertical-align: top; margin-right: 2px;" />Your Calendars</a>				
		</div>
		
		<div id="iconbar">
			<a id="sync_button" onclick="Sync()" ><img title="Sync" class="icon" src="images/02-redo@2x.png" height="16" /></a>
			<a id="setting_button"><img title="Settings" class="icon" src="images/cog_icon_16.png" /></a>
			<a id="help_button"><img title="Help" class="icon" src="images/59-info@2x.png"  height="16"  /></a>
			<!-- <a onclick="open_background_dialog()"><img class="icon" src="images/picture_icon_16.png" /></a> -->
		</div>
   	</header>
	
	<div id="content" style="left: 0px; display: block; right: 0px;">

		  <div id="views">
		    <div id="tasks">
		     
		      <div id="listsoftasks">
		      </div>
		      
		    </div>
		  </div>		
				
		  <div id="calendarview" style="font-size: 14px">
		  	<div id='calendar'></div>
		  </div>
	</div>
	
	<div id="menublur"></div>

	<div id="bottombar">
		<div id="left">
			<a onclick="addlist_window()" class="bottom_button">
				<img class="icon" src="images/16-plus.png" style="" />
				<span class="text">Add List</span>
			</a>
			<!-- <a class="bottombutton" onclick="Sync()">Sync</a> 
			<a class="bottombutton" onclick="setting_windows()">Settings</a> -->
		</div>		
		<div id="right">
			<div class="listfilter">
				<span class="divider"></span>
				<button class="filterselected" onclick="show_all_div()" id="allbutton" >all</button>
			</div>
		</div>
	</div>

	<!-- Help Overlay -->
	

	<div id="dialog" style="display: none">
		<p>Go to the following link, login your google account and grant access: 
		<a id="authlink" href='' target="_blank">authorization link</a><br />
		<p>Copy and paste the validation code from Google; Paste it into here and press validate. <br />
		<input class="input-login" type="text" id="validation" name="email" placeholder="Validation Code"></p>
		
		<div id="account-buttons" class="ui-dialog-buttonset">        
	        <!-- LOGIN BUTTONS -->
	        <div class="loginbuttons">
	         	<input class="input-button register button-login" type="submit" id="validate_button" value="Validate Code">          	        
	        </div>
	    </div>
	</div>

	<div id="dialog_help" style="display: none">
		<p>
			<table style="font-size: 12px" id="hotkeytable">
			  <tr>
			  	<thead><strong>Hotkeys</strong></thead>
			  </tr>
			  <tr>
			    <td>↑</td>
			    <td>Move selection up</td>
			  </tr>
			  <tr>
			    <td>↓</td>
			    <td>Move selection down</td>
			  </tr>
			  <tr>
			    <td>Enter &nbsp;</td>
			    <td>Open or close the currently selected task</td>
			  </tr>
			  <tr>
			    <td>Del &nbsp;</td>
			    <td>Delete the currently selected task</td>
			  </tr>
			</table>
			<br />
			<strong>Entering a new task:</strong> 
			Click on the add list button. Enter your task name and press <span class="keyboard">Enter</span> to save the task. You can do so continously until you finish adding all your tasks.
			<br />
			<br />
			<strong>Editing a task:</strong>
			Double click on a task; Or hit the Enter key on the currently selected task. Hit the Enter key again to save.
		</p>			
	</div>

	<div id="dialog_addlist" style="display: none">
		<p>Name of the list: <br />
		<input class="input-login" type="text" id="list_name" name="name" placeholder="name"></p>
		<p>Description for the list: <br />
		<input class="input-login" type="text" id="list_description" name="description" placeholder="description"></p>
		
		<div id="account-buttons" class="ui-dialog-buttonset">        
	        <!-- LOGIN BUTTONS -->
	        <div class="loginbuttons">
	         	<input class="input-button register button-login" type="submit" id="addlistbutton" onclick="add_list()" value="Add List">  
	         	<input class="input-button register button-login" type="submit" id="editlistbutton" onclick="edit_list()" value="Save">        	        
	        </div>
	    </div>
	</div>

	<div id="dialog_changebackground" style="display: none">
		<p>Choose an image file: <br />
		<input class="input-login" type="file" id="background_file" name="description" placeholder="description"></p>
		
		<div id="account-buttons" class="ui-dialog-buttonset">        
	        <!-- LOGIN BUTTONS -->
	        <div class="loginbuttons">
	         	<input class="input-button register button-login" type="submit" id="addlistbutton" onclick="background_change()" value="Change Background">          	        
	        </div>
	    </div>
	</div>

	<!--- container to hold notifications, and default templates --->
	<div id="container" style="display:none">

		<div id="default">
			<h1>#{title}</h1>
			<p>#{text}</p>
		</div>

		<div id="sticky">
			<a class="ui-notify-close ui-notify-cross" href="#">x</a>
			<h1>#{title}</h1>
			<p>#{text}</p>
		</div>

		<div id="withIcon">
			<a class="ui-notify-close ui-notify-cross" href="#">x</a>
			<div style="float:left;margin:0 10px 0 0"><img src="#{icon}" alt="warning" /></div>
			<h1>#{title}</h1>
			<p>#{text}</p>
		</div>

		<div id="buttons">
			<h1>#{title}</h1>
			<p>#{text}</p>
			<p style="margin-top:10px;text-align:center">
				<input type="button" class="confirm" value="Close Dialog" />
			</p>
		</div>
	</div>

<div id="ui-datepicker-div" class="ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all"></div></body></html>