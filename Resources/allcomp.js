((function(){var BackgroundImage,DeletedList,Deletion,Finished,Initialized,List,Set,Task,TestStorage,Token,Version,exports,make_child,nextItem,open_for_edit,pressed_delete,prevItem,setting_url,ti_window,updateItems;(function(){var a,b,c,d,e,f,g,h,i,j,k;return typeof exports!="undefined"?g=exports:g=this.Spine={},g.version="0.0.4",a=g.$=this.jQuery||this.Zepto||function(){return arguments[0]},j=g.makeArray=function(a){return Array.prototype.slice.call(a,0)},i=g.isArray=function(a){return Object.prototype.toString.call(a)==="[object Array]"},typeof Array.prototype.indexOf=="undefined"&&(Array.prototype.indexOf=function(a){var b;b=0;while(b<this.length){if(this[b]===a)return b;b++}return-1}),d=g.Events={bind:function(a,b){var c,d,e;d=a.split(" "),c=this._callbacks||(this._callbacks={}),e=0;while(e<d.length)(this._callbacks[d[e]]||(this._callbacks[d[e]]=[])).push(b),e++;return this},trigger:function(){var a,b,c,d,e,f;a=j(arguments),c=a.shift();if(!(b=this._callbacks))return!1;if(!(f=this._callbacks[c]))return!1;d=0,e=f.length;while(d<e){if(f[d].apply(this,a)===!1)return!1;d++}return!0},unbind:function(a,b){var c,d,e,f;if(!a)return this._callbacks={},this;if(!(c=this._callbacks))return this;if(!(f=c[a]))return this;if(!b)return delete this._callbacks[a],this;d=0,e=f.length;while(d<e){if(b===f[d]){f=f.slice(),f.splice(d,1),c[a]=f;break}d++}return this}},e=g.Log={trace:!0,logPrefix:"(App)",log:function(){var a;if(!this.trace)return;if(typeof console=="undefined")return;return a=j(arguments),this.logPrefix&&a.unshift(this.logPrefix),console.log.apply(console,a),this}},typeof Object.create!="function"&&(Object.create=function(a){var b;return b=function(){},b.prototype=a,new b}),k=["included","extended"],b=g.Class={inherited:function(){},created:function(){},prototype:{initialize:function(){},init:function(){}},create:function(a,b){var c;return c=Object.create(this),c.parent=this,c.prototype=c.fn=Object.create(this.prototype),a&&c.include(a),b&&c.extend(b),c.created(),this.inherited(c),c},init:function(){var a;return a=Object.create(this.prototype),a.parent=this,a.initialize.apply(a,arguments),a.init.apply(a,arguments),a},proxy:function(a){var b;return b=this,function(){return a.apply(b,arguments)}},proxyAll:function(){var a,b,c;a=j(arguments),b=0,c=[];while(b<a.length)this[a[b]]=this.proxy(this[a[b]]),c.push(b++);return c},include:function(a){var b,c;for(c in a)k.indexOf(c)===-1&&(this.fn[c]=a[c]);return b=a.included,b&&b.apply(this),this},extend:function(a){var b,c;for(c in a)k.indexOf(c)===-1&&(this[c]=a[c]);return b=a.extended,b&&b.apply(this),this}},b.prototype.proxy=b.proxy,b.prototype.proxyAll=b.proxyAll,b.inst=b.init,b.sub=b.create,g.guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b,c;return b=Math.random()*16|0,c=a==="x"?b:b&3|8,c.toString(16)}).toUpperCase()},f=g.Model=b.create(),f.extend(d),f.extend({setup:function(a,b){var c;return c=f.sub(),a&&(c.name=a),b&&(c.attributes=b),c},created:function(a){return this.records={},this.attributes=this.attributes?j(this.attributes):[]},find:function(a){var b;b=this.records[a];if(!b)throw"Unknown record";return b.clone()},exists:function(a){try{return this.find(a)}catch(b){return!1}},refresh:function(a){var b,c,d;a=this.fromJSON(a),this.records={},b=0,c=a.length;while(b<c)d=a[b],d.newRecord=!1,this.records[d.id]=d,b++;return this.trigger("refresh"),this},select:function(a){var b,c;c=[];for(b in this.records)a(this.records[b])&&c.push(this.records[b]);return this.cloneArray(c)},findByAttribute:function(a,b){var c;for(c in this.records)if(this.records[c][a]===b)return this.records[c].clone()},findAllByAttribute:function(a,b){return this.select(function(c){return c[a]===b})},each:function(a){var b,c;c=[];for(b in this.records)c.push(a(this.records[b]));return c},all:function(){return this.cloneArray(this.recordsValues())},first:function(){var a;return a=this.recordsValues()[0],a&&a.clone()},last:function(){var a,b;return b=this.recordsValues(),a=b[b.length-1],a&&a.clone()},count:function(){return this.recordsValues().length},deleteAll:function(){var a,b;b=[];for(a in this.records)b.push(delete this.records[a]);return b},destroyAll:function(){var a,b;b=[];for(a in this.records)b.push(this.records[a].destroy());return b},update:function(a,b){return this.find(a).updateAttributes(b)},create:function(a){var b;return b=this.init(a),b.save()},destroy:function(a){return this.find(a).destroy()},sync:function(a){return this.bind("change",a)},fetch:function(a){return typeof a=="function"?this.bind("fetch",a):this.trigger.apply(this,["fetch"].concat(j(arguments)))},toJSON:function(){return this.recordsValues()},fromJSON:function(a){var b,c;if(!a)return;typeof a=="string"&&(a=JSON.parse(a));if(i(a)){c=[],b=0;while(b<a.length)c.push(this.init(a[b])),b++;return c}return this.init(a)},recordsValues:function(){var a,b;b=[];for(a in this.records)b.push(this.records[a]);return b},cloneArray:function(a){var b,c;c=[],b=0;while(b<a.length)c.push(a[b].clone()),b++;return c}}),f.include({model:!0,newRecord:!0,init:function(a){return a&&this.load(a),this.trigger("init",this)},isNew:function(){return this.newRecord},isValid:function(){return!this.validate()},validate:function(){},load:function(a){var b,c;c=[];for(b in a)c.push(this[b]=a[b]);return c},attributes:function(){var a,b,c;c={},b=0;while(b<this.parent.attributes.length)a=this.parent.attributes[b],c[a]=this[a],b++;return c.id=this.id,c},eql:function(a){return a&&a.id===this.id&&a.parent===this.parent},save:function(){var a;return a=this.validate(),a?(this.trigger("error",this,a),!1):(this.trigger("beforeSave",this),this.newRecord?this.create():this.update(),this.trigger("save",this),this)},updateAttribute:function(a,b){return this[a]=b,this.save()},updateAttributes:function(a){return this.load(a),this.save()},destroy:function(){return this.trigger("beforeDestroy",this),delete this.parent.records[this.id],this.destroyed=!0,this.trigger("destroy",this),this.trigger("change",this,"destroy")},dup:function(){var a;return a=this.parent.init(this.attributes()),a.newRecord=this.newRecord,a},clone:function(){return Object.create(this)},reload:function(){var a;return this.newRecord?this:(a=this.parent.find(this.id),this.load(a.attributes()),a)},toJSON:function(){return this.attributes()},exists:function(){return this.id&&this.id in this.parent.records},update:function(){var a,b;return this.trigger("beforeUpdate",this),b=this.parent.records,b[this.id].load(this.attributes()),a=b[this.id].clone(),this.trigger("update",a),this.trigger("change",a,"update")},create:function(){var a,b;return this.trigger("beforeCreate",this),this.id||(this.id=g.guid()),this.newRecord=!1,b=this.parent.records,b[this.id]=this.dup(),a=b[this.id].clone(),this.trigger("create",a),this.trigger("change",a,"create")},bind:function(a,b){return this.parent.bind(a,this.proxy(function(a){if(a&&this.eql(a))return b.apply(this,arguments)}))},trigger:function(){return this.parent.trigger.apply(this.parent,arguments)}}),h=/^(\w+)\s*(.*)$/,c=g.Controller=b.create({tag:"div",initialize:function(b){var c;this.options=b;for(c in this.options)this[c]=this.options[c];this.el||(this.el=document.createElement(this.tag)),this.el=a(this.el),this.events||(this.events=this.parent.events),this.elements||(this.elements=this.parent.elements),this.events&&this.delegateEvents(),this.elements&&this.refreshElements();if(this.proxied)return this.proxyAll.apply(this,this.proxied)},$:function(b){return a(b,this.el)},delegateEvents:function(){var a,b,c,d,e,f,g;g=[];for(b in this.events)e=this.events[b],d=this.proxy(this[e]),c=b.match(h),a=c[1],f=c[2],g.push(f===""?this.el.bind(a,d):this.el.delegate(f,a,d));return g},refreshElements:function(){var a,b;b=[];for(a in this.elements)b.push(this[this.elements[a]]=this.$(a));return b},delay:function(a,b){return setTimeout(this.proxy(a),b||0)}}),c.include(d),c.include(e),g.App=b.create(),g.App.extend(d),c.fn.App=g.App})(),Set=function(){function a(a){this._set=a===void 0?[]:a,this.length=this._set.length,this.contains=function(a){return this._set.indexOf(a)!==-1}}return a.prototype.union=function(a){var b,c,d,e;b=a.length>this.length?a:this,c=a.length>this.length?this:a,e=b.copy(),d=0;while(d<c.length)e.add(c._set[d]),d++;return e},a.prototype.intersection=function(b){var c,d,e,f,g;g=new a,c=b.length>this.length?b:this,d=b.length>this.length?this:b,f=0;while(f<d.length)e=d._set[f],c.contains(e)&&g.add(e),f++;return g},a.prototype.difference=function(b){var c,d,e;e=new a,d=0;while(d<this.length)c=this._set[d],b.contains(c)||e.add(c),d++;return e},a.prototype.symmetricDifference=function(a){return this.union(a).difference(this.intersection(a))},a.prototype.isSuperSet=function(a){var b;b=0;while(b<a.length){if(!this.contains(a._set[b]))return!1;b++}return!0},a.prototype.isSubSet=function(a){var b;b=0;while(b<this.length){if(!a.contains(this._set[b]))return!1;b++}return!0},a.prototype.add=function(a){return this._set.indexOf(a)===-1&&(this._set.push(a),this.length++),this.length},a.prototype.remove=function(a){var b;return b=this._set.indexOf(a),b!==-1?(this.length--,this._set.splice(b,1)[0]):null},a.prototype.copy=function(){return new a(this._set.slice())},a.prototype.asArray=function(){return this._set},a}(),exports=this,exports.Set=Set,function(a){var b,c;return c=Titanium.Filesystem.getFile(Titanium.Filesystem.getApplicationDataDirectory(),"gtasktic.db"),b=Titanium.Database.openFile(c),String.prototype.replaceAll=function(a,b){var c;return c=new RegExp(a,"ig"),this.replace(c,b)},b.execute("CREATE TABLE IF NOT EXISTS keyval ( key TEXT, value TEXT )"),Spine.Model.Local={extended:function(){return this.sync(this.proxy(this.saveLocal)),this.fetch(this.proxy(this.loadLocal))},saveLocal:function(){var a;return a=JSON.stringify(this),b.execute("DELETE from keyval where key ='"+this.name+"'"),a=a.replaceAll("'","''"),b.execute("INSERT INTO keyval (key, value) VALUES ('"+this.name+"', '"+a+"')")},loadLocal:function(){var a,c;c=b.execute("SELECT value FROM keyval WHERE key = '"+this.name+"' LIMIT 1"),a=c.field(0);if(!a)return;return a=JSON.parse(a),this.refresh(a)}}}(jQuery),Finished=Spine.Model.setup("Finished",["name","done","time","duedate","note","order","synced","listid","time_finished"]),Finished.extend(Spine.Model.Local),Task=Spine.Model.setup("Task",["name","done","time","duedate","note","order","synced","listid","updated"]),Task.extend(Spine.Model.Local),Task.extend({active:function(a){return this.select(function(b){return!b.done&&b.listid===a})},done:function(a){return this.select(function(b){return!!b.done&&b.listid===a})},list:function(a){return this.select(function(b){return b.listid===a})},synced:function(){return this.select(function(a){return!a.synced||!a.updated})},destroyDone:function(a){return this.done(a).forEach(function(a){return Deletion.create({deletion_id:a.synced===!0?a.id:void 0}),a.destroy()})},logDone:function(a){return this.done(a).forEach(function(a){var b,c;return a.synced===!0&&(b=a,navigator.onLine?($("#syncbutton")[0].src="images/ajax-loader.gif",window.settingapp.setup_api_on_entry(function(){return Task.delete_from_cloud(b,function(){return $("#syncbutton")[0].src="images/02-redo@2x.png"})})):(c=Deletion.init({deletion_id:a.id,listid:a.listid}),c.id=a.id,c.save())),Finished.create({name:a.name,note:a.note,listid:a.listid,time_finished:moment().format("MM/DD/YYYY")}),a.destroy()})},toCloudStructure:function(a){var b;return b={title:a.name},a.duedate!=null&&a.duedate!==""&&(b.due=moment(a.duedate).format("YYYY-MM-DD")+"T12:00:00.000Z"),a.note!=null&&a.note!==""&&(b.notes=a.note),a.done?b.status="completed":b.status="needsAction",b},add_from_cloud:function(a,b){var c,d;return console.log("add from cloud"),a.title===""?!0:(c=null,a.hasOwnProperty("due")&&(c=(new Date(a.due)).format("mm/dd/yyyy")),d=Task.init({name:a.title,time:moment(a.updated).add("milliseconds",window.time_difference).toString(),synced:!0,done:a.status==="completed",duedate:c,listid:a.listid,updated:!0}),d.id=a.id,a.hasOwnProperty("notes")&&(d.note=a.notes),d.save())},add_to_cloud:function(a,b){var c,d,e;return console.log("add to cloud"),c=Task.toCloudStructure(a),e={path:"/tasks/v1/lists/"+a.listid+"/tasks",method:"POST",params:"",body:c},d=gapi.client.request(e),window.incrementer[a.listid]=window.incrementer[a.listid]+1,d.execute(function(d){var e,f;return console.log(d),window.add_response=d,f=a.id,c={name:a.name,time:(moment(d.updated)+window.time_difference).toString(),listid:a.listid,order:a.order,synced:!0,updated:!0},a.duedate!=null&&(c.duedate=a.duedate),a.note!=null&&(c.note=a.note),e=Task.init(c),e.id=d.id,e.save(),a.destroy(),window.incrementer[a.listid]=window.incrementer[a.listid]-1,b(e)})},delete_from_cloud:function(a,b){var c,d;return console.log("delete from cloud"),d={path:"/tasks/v1/lists/"+a.listid+"/tasks/"+a.id,method:"DELETE",params:"",body:""},c=gapi.client.request(d),c.execute(function(a){return console.log(a),window.delete_response=a,b()})},update_to_cloud:function(a,b){var c,d,e;return console.log("update to cloud"),c=Task.toCloudStructure(a),c.id=a.id,window.updatedata=c,e={path:"/tasks/v1/lists/"+a.listid+"/tasks/"+a.id,method:"PUT",params:"",body:c},d=gapi.client.request(e),d.execute(function(c){return console.log(c),window.update_response=c,a.updated=!0,a.save(),b(a)})},update_to_local:function(a,b){var c,d;return console.log("update to local"),d=Task.find(a.id),c=null,a.hasOwnProperty("due")&&(c=(new Date(a.due)).format("mm/dd/yyyy")),d.updateAttributes({name:a.title,time:moment(a.updated).toString(),synced:!0,done:a.status==="completed",duedate:c,listid:a.listid})}}),Deletion=Spine.Model.setup("Deletion",["deletion_id","listid"]),Deletion.extend(Spine.Model.Local),DeletedList=Spine.Model.setup("DeletedList",["deletion_id"]),DeletedList.extend(Spine.Model.Local),List=Spine.Model.setup("List",["name","description","synced","time","updated"]),List.extend(Spine.Model.Local),List.extend({add_from_cloud:function(a,b){var c;return c=List.init({name:a.title,time:(new Date).toString()}),c.id=a.id,c.synced=!0,c.updated=!0,c.save(),b(c)},synced:function(){return this.select(function(a){return!a.synced||!a.updated})},add_to_cloud:function(a,b){var c,d;return a.id==="@default"?!0:(d={path:"/tasks/v1/users/@me/lists",method:"POST",params:"",body:{title:a.name}},c=gapi.client.request(d),c.execute(function(c){var d,e,f,g,h,i;console.log(c),window.add_response=c,e=a.id,d=List.init({name:a.name,time:(new Date).toString(),synced:!0,updated:!0}),d.id=c.id,d.save(),i=Task.findAllByAttribute("listid",e);for(g=0,h=i.length;g<h;g++)f=i[g],f.listid=d.id,f.save();return a.destroy(),b(d)}))},delete_from_cloud:function(a,b){var c,d;return d={path:"/tasks/v1/users/@me/lists/"+a,method:"DELETE",params:"",body:""},c=gapi.client.request(d),c.execute(function(a){return console.log(a),window.delete_response=a,b()})},update_to_cloud:function(a,b){var c,d;return d={path:"/tasks/v1/users/@me/lists/"+a.id,method:"PUT",params:"",body:{id:a.id,kind:"tasks#taskList",title:a.name}},c=gapi.client.request(d),c.execute(function(c){return console.log(c),window.update_response=c,b(a)})}}),Version=Spine.Model.setup("Version",["number"]),Version.extend(Spine.Model.Local),Initialized=Spine.Model.setup("Initialized",["flag"]),Initialized.extend(Spine.Model.Local),Token=Spine.Model.setup("Token",["current_token","expiration","refresh_token"]),Token.extend(Spine.Model.Local),TestStorage=Spine.Model.setup("TestStorage",["stored"]),TestStorage.extend(Spine.Model.Local),BackgroundImage=Spine.Model.setup("BackgroundImage",["image"]),BackgroundImage.extend(Spine.Model.Local),exports=this,exports.Deletion=Deletion,exports.Task=Task,exports.DeletedList=DeletedList,exports.List=List,exports.Version=Version,exports.Initialized=Initialized,exports.Token=Token,exports.Finished=Finished,exports.BackgroundImage=BackgroundImage,window.initialize_and_sync_list=function(){if(navigator.onLine&&Token.first().refresh_token!=="")return $("#syncbutton")[0].src="images/ajax-loader.gif",window.settingapp.setup_api_on_entry(window.find_time_difference)},window.time_difference=null,window.find_time_difference=function(){var a,b,c;return a=moment(),c={path:"/tasks/v1/lists/@default/tasks",method:"POST",params:"",body:{title:"testing time"}},b=gapi.client.request(c),b.execute(function(d){var e;return console.log(d),e=moment(d.updated),window.time_difference=a-e,c={path:"/tasks/v1/lists/@default/tasks/"+d.id,method:"DELETE",params:"",body:""},b=gapi.client.request(c),b.execute(function(a){return window.delete_tasks()})})},window.incrementer={},window.delete_lists=function(){var a,b,c,d,e,f,g,h;window.incrementer.delete_list=0,g=DeletedList.all();for(c=0,e=g.length;c<e;c++)a=g[c],window.incrementer.delete_list=window.incrementer.delete_list+1,List.delete_from_cloud(a.deletion_id,function(){var a,b,c,d;window.incrementer.delete_list=window.incrementer.delete_list-1;if(window.incrementer.delete_list===0){d=DeletedList.all();for(b=0,c=d.length;b<c;b++)a=d[b],a.destroy();return window.sync_list()}});if(window.incrementer.delete_list===0){h=DeletedList.all();for(d=0,f=h.length;d<f;d++)b=h[d],b.destroy();return window.sync_list()}},window.delete_tasks=function(){var a,b,c,d,e,f,g,h;window.incrementer.delete_task=0,g=Deletion.all();for(c=0,e=g.length;c<e;c++)a=g[c],window.incrementer.delete_task=window.incrementer.delete_task+1,Task.delete_from_cloud(a,function(){var a,b,c,d;window.incrementer.delete_task=window.incrementer.delete_task-1;if(window.incrementer.delete_task===0){d=Deletion.all();for(b=0,c=d.length;b<c;b++)a=d[b],a.destroy();return window.delete_lists()}});if(window.incrementer.delete_task===0){h=Deletion.all();for(d=0,f=h.length;d<f;d++)b=h[d],b.destroy();return window.delete_lists()}},window.sync_task=function(a){var b,c;return c={path:"/tasks/v1/lists/"+a.id+"/tasks",method:"GET",params:"",body:""},b=gapi.client.request(c),window.incrementer[a.id]=0,b.execute(function(b){var c,d,e,f,g;window.list_response=b,d=[];if(b.items!=null){d=b.items;for(f=0,g=d.length;f<g;f++)c=d[f],c.listid=a.id}return e=Task.findAllByAttribute("listid",a.id),window.local_cloud_sync(e,d,Task,function(b){if(window.incrementer[b.listid]===0)return $("#"+b.listid).length>0?List.find(a.id).save():window.App.render_new(List.find(b.listid))}),window.check_no_incoming_calls(function(){var a,b,c,d;d=List.all();for(b=0,c=d.length;b<c;b++)a=d[b],$("#"+a.id).length>0?List.find(a.id).save():window.App.render_new(List.find(a.id));return $("#syncbutton")[0].src="images/02-redo@2x.png"})})},window.sync_list=function(){var a;return List.exists("@default")?(a=gapi.client.tasks.tasklists.get({tasklist:"@default"}),a.execute(function(b){var c,d,e,f,g,h;c=List.find("@default"),d=List.init({name:b.title,time:(new Date).toString()}),d.id=b.id,d.save(),h=Task.findAllByAttribute("listid",c.id);for(f=0,g=h.length;f<g;f++)e=h[f],e.listid=d.id,e.save();return c.destroy(),a=gapi.client.tasks.tasklists.list(),a.execute(function(a){return window.list_response=a,window.local_cloud_sync(List.all(),a.items,List,window.sync_task)})})):(a=gapi.client.tasks.tasklists.list(),a.execute(function(a){return window.list_response=a,window.local_cloud_sync(List.all(),a.items,List,window.sync_task),!0}))},window.de_array=function(a){var b,c,d,e,f;c={},d=[];for(e=0,f=a.length;e<f;e++)b=a[e],c[b.id]=b,d.push(b.id);return[c,d]},window.local_cloud_sync=function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;p=de_array(a),i=p[0],j=p[1],q=de_array(b),e=q[0],f=q[1],window.local_set=new Set(j),window.cloud_set=new Set(f),r=local_set.difference(cloud_set)._set;for(l=0,n=r.length;l<n;l++)h=r[l],i[h].synced===!1?(window.local_dict=i,c.add_to_cloud(i[h],d)):c.find(h).destroy();window.cloud_dict=function(){var a,b,f,g;f=cloud_set.difference(local_set)._set,g=[];for(a=0,b=f.length;a<b;a++)h=f[a],g.push(c.add_from_cloud(e[h],d));return g}(),s=cloud_set.intersection(local_set)._set,t=[];for(m=0,o=s.length;m<o;m++)h=s[m],t.push(e[h].updated!=null?(k=moment(i[h].time),g=moment(e[h].updated).add("milliseconds",window.time_difference),k>g?c.update_to_cloud(i[h],d):c.update_to_local(e[h],d)):typeof parent_id!="undefined"&&parent_id!==null?c.update_to_cloud(i[h],d,parent_id):c.update_to_cloud(i[h],d));return t},window.check_no_incoming_calls=function(a){var b,c,d,e,f;c=0,f=window.incrementer;for(d=0,e=f.length;d<e;d++)b=f[d],c=d+c;if(c===0)return a()},window.dynamic_load_gapi=function(callback){var xhr;return xhr=new XMLHttpRequest,xhr.open("GET","https://apis.google.com/js/client.js",!0),xhr.send(null),xhr.onreadystatechange=function(status,response){var a;if(xhr.readyState!==4)return;return eval(xhr.response),a=setTimeout(callback,2e3)}},window.gapi_loaded=!1,window.online=function(a){return navigator.onLine?($("#sync_button").removeClass("disabled"),$(document).ready(function(){return window.gapi_loaded?window.initialize_and_sync_list():(dynamic_load_gapi("window.initialize_and_sync_list()"),window.gapi_loaded=!0)})):$("#sync_button").addClass("disabled")},addEvent(window,"online",online),addEvent(window,"offline",online),online({type:"ready"}),Task.ordersort=function(a,b){return a.order<b.order?-1:1},jQuery(function(a){return window.Tasks=Spine.Controller.create({tag:"li",proxied:["render","remove"],events:{"change   input[type=checkbox]":"toggle","click    .destroy":"destroy","dblclick .item":"edit","click .item":"toggle_select","keypress input[type=text]":"blurOnEnter","submit .edittask_form":"close"},elements:{"input.name":"input",".item":"wrapper",".datepicker":"inputdate","textarea.note":"textarea"},init:function(){return this.item.bind("update",this.render),window.taskdict[this.item.id]=this,this.item.bind("destroy",this.remove)},render:function(){var b;return b=a("#taskTemplate").tmpl(this.item),this.el.html(b),this.refreshElements(),this.el.data("id",this.item.id),this.el.find(".datepicker").datepicker({constrainInput:!0}),this},toggle:function(){var b;return this.item.done=!this.item.done,this.item.time=moment().toString(),navigator.onLine?(a("#syncbutton")[0].src="images/ajax-loader.gif",this.item.updated=!0,this.item.save(),b=this.item,window.settingapp.setup_api_on_entry(function(){return Task.update_to_cloud(b,function(){return a("#syncbutton")[0].src="images/02-redo@2x.png"})})):(this.item.updated=!1,this.item.save())},destroy:function(){var b,c;return this.item.synced===!0&&(b=this.item,navigator.onLine?(a("#syncbutton")[0].src="images/ajax-loader.gif",window.settingapp.setup_api_on_entry(function(){return Task.delete_from_cloud(b,function(){return a("#syncbutton")[0].src="images/02-redo@2x.png"})})):(c=Deletion.init({deletion_id:this.item.id,listid:this.item.listid}),c.id=this.item.id,c.save())),this.item.destroy()},edit:function(){if(this.wrapper.hasClass("editing"))return;return this.el.hasClass("task_selected")&&this.el.removeClass("task_selected"),window.last_opened!==""&&window.taskdict[window.last_opened].close(),window.last_opened=this.item.id,this.wrapper.addClass("editing"),this.input.focus()},blurOnEnter:function(a){if(a.keyCode===13)return a.target.blur()},toggle_select:function(){var b;if(this.wrapper.hasClass("editing"))return;return window.last_opened!==""&&window.taskdict[window.last_opened].close(),window.last_opened="",a(".task_selected").removeClass("task_selected"),b=this.el,a("li").each(function(c,d){if(a(d).data("id")===a(b).data("id"))return window.cur=c}),this.el.addClass("task_selected")},close:function(){var b,c,d;return d=this.input.val().replace("'","''"),this.wrapper.removeClass("editing"),navigator.onLine?(a("#syncbutton")[0].src="images/ajax-loader.gif",this.item.updateAttributes({name:d,time:moment().toString(),duedate:this.inputdate.val(),note:this.textarea.val(),updated:!0}),b=this.item,window.settingapp.setup_api_on_entry(function(){return Task.update_to_cloud(b,function(){return a("#syncbutton")[0].src="images/02-redo@2x.png"})})):this.item.updateAttributes({name:d,time:moment().toString(),duedate:this.inputdate.val(),note:this.textarea.val(),updated:!1}),this.el.addClass("task_selected"),c=this.el,a("li").each(function(b,d){if(a(d).data("id")===a(c).data("id"))return window.cur=b}),window.last_opened="",!1},remove:function(){return this.el.remove()}}),window.TaskApp=Spine.Controller.create({tag:"div",proxied:["addAll","render","renderCount","remove","attach"],events:{"click  .clear":"clear","click  a.add":"addOne","click  .deletelist":"deletelist","click  .editlist":"editlist","submit form.addform":"create_new"},elements:{".items":"items",".countVal":"count",".clear":"clear",".add":"add",".addinputs .addtasks":"input",".addinputs":"addform"},init:function(){return this.item.bind("update",this.render),this.item.bind("update",this.attach),this.item.bind("destroy",this.remove),Task.bind("change",this.renderCount),Task.fetch()},addAll:function(){var b,c;return c=Task.list(this.item.id).sort(Task.ordersort),b=this.el,a.each(c,function(a,c){var d;return d=Tasks.init({item:c}),b.find(".items").append(d.render().el)})},render:function(){var b,c,d,e,f,g;return b=a("#listTemplate").tmpl(this.item),this.el.html(b),this.refreshElements(),this.el.data("id",this.item.id),this.addAll(),this.item.id==="@default"&&this.el.addClass("firstlist"),this.renderCount(),c=a(".listfilter"),e="l"+String(this.item.id).replace("@",""),a("#"+e).remove(),d="<button id='"+e+"'>"+this.item.name+"</button>",c.prepend(d),this.tab=a(String("#"+e)),f="#"+this.item.id,g=this.tab,this.tab.click(function(){return a(".listdiv").hide(),f==="#@default"?a(".firstlist .listdiv").show():a(f).show(),a(".filterselected").removeClass("filterselected"),g.addClass("filterselected")}),this},renderCount:function(){var a,b;return a=Task.active(this.item.id).length,this.count.text(a),b=Task.done(this.item.id).length},clear:function(){return Task.logDone(this.item.id)},addOne:function(){var a,b;return a=Task.create({name:"",time:moment().toString(),done:!1,order:Task.all().length+1,synced:!1,listid:this.item.id}),b=Tasks.init({item:a}),this.items.append(b.render().el),b.edit()},deletelist:function(){var b,c,d;c=confirm("Are you sure you want to delete this list and all it's tasks");if(c)return navigator.onLine?this.item.synced&&(b=this.item.id,a("#syncbutton")[0].src="images/ajax-loader.gif",window.settingapp.setup_api_on_entry(function(){return List.delete_from_cloud(b,function(){return a("#syncbutton")[0].src="images/02-redo@2x.png"})})):(DeletedList.create({deletion_id:this.item.synced===!0?this.item.id:void 0}),d=Task.list(this.item.id),a.each(d,function(a,b){return Deletion.create({deletion_id:b.id,listid:b.synced===!0?b.listid:void 0}),b.destroy()})),this.remove(),this.item.destroy()},create_new:function(){var b,c,d,e;return b=this.input.val().replace("'","''"),navigator.onLine?(a("#syncbutton")[0].src="images/ajax-loader.gif",c=Task.create({name:b,time:moment().toString(),done:!1,order:Task.all().length+1,synced:!0,listid:this.item.id,updated:!0}),d=this.items,window.settingapp.setup_api_on_entry(function(){return Task.add_to_cloud(c,function(b){var c;return a("#syncbutton")[0].src="images/02-redo@2x.png",c=Tasks.init({item:b}),d.append(c.render().el)})})):c=Task.create({name:b,time:moment().toString(),done:!1,order:Task.all().length+1,synced:!1,listid:this.item.id,updated:!1}),e=Tasks.init({item:c}),this.items.append(e.render().el),this.input.val(""),!1},remove:function(){return this.el.remove(),this.tab.remove()},editlist:function(){var b;return a("#list_name").val(this.item.name),a("#list_description").val(this.item.description),b=a("#dialog_addlist").dialog({modal:!0,title:"Edit this list",dialogClass:"editing",buttons:{"Edit List":function(){return edit_list(),a(this).dialog("close")}}}),b.data("id",this.item.id)},attach:function(){return this.el.find(".roundedlist").sortable({update:function(b,c){return a(".roundedlist li").each(function(b){var c,d,e,f,g;if(navigator.onLine)return c=Task.find(a(this).data("id")),d=a(this).parent().parent()[0].id,c.listid!==a(this).parent().parent()[0].id?(a("#syncbutton")[0].src="images/ajax-loader.gif",f=Task.init({name:c.name,time:moment().toString(),done:c.done,order:a(this).index(),synced:!1,listid:a(this).parent().parent()[0].id,updated:!1}),f.save(),g=List.find(d),g.save(),window.settingapp.setup_api_on_entry(function(){return Task.add_to_cloud(f,function(b){return a("#syncbutton")[0].src="images/02-redo@2x.png",g.save()})}),window.settingapp.setup_api_on_entry(function(){return Task.delete_from_cloud(c,function(){return console.log("old task deleted")})}),c.destroy()):(c.order=a(this).index(),c.save());c=Task.find(a(this).data("id")),d=a(this).parent().parent()[0].id;if(c.listid===a(this).parent().parent()[0].id)return c.order=a(this).index(),c.save();f=Task.init({name:c.name,time:moment().toString(),done:c.done,order:a(this).index(),synced:!1,listid:a(this).parent().parent()[0].id,updated:!1}),f.save(),c.destroy();if(List.exists(d))return e=List.find(d),e.save()})},connectWith:".connectedsortable"}),this.el.find(".addinputs").toggle(),this.el.find(".addtoggle").click(function(b){var c;return c=a(this),c.toggle(),c.parent().children(".addinputs").toggle(),c.parent().find(".addinputs .addtasks").focus()}),this.el.find(".doneadding").click(function(b){var c;return c=a(this),c.parent().parent().children(".addtoggle").toggle(),c.parent().toggle()})}}),window.allLists=Spine.Controller.create({el:a("#listsoftasks"),proxied:["render"],init:function(){return List.fetch(),this.render()},render:function(){var b,c;return c=List.all(),b=this.el,a.each(c,function(a,c){var d;return d=TaskApp.init({item:c}),b.append(d.render().el),d.attach()})},render_new:function(a){var b;return b=TaskApp.init({item:a}),this.el.append(b.render().el),b.attach()}}),window.App=allLists.init()}),jQuery(function(a){return window.SettingApp=Spine.Controller.create({events:{"click #setting_button":"setting_window","click #validate_button":"validate_code","click #help_button":"show_help","click #background_button":"background_change_window","click #change_background_button":"background_change"},init:function(){var b;return window.there_upload_pic=!1,b=a("#fileuploader")[0],b.onchange=function(c){var d,e;return c.preventDefault(),d=b.files[0],e=new FileReader,window.there_upload_pic=!1,e.onload=function(b){var c,d;return window.there_upload_pic=!0,c=a("#holder")[0],window.imageevent=b,d=new Image,d.src=b.target.result,d.width=276,c.innerHTML="",c.appendChild(d)},e.readAsDataURL(d),!1}},background_change_window:function(){return a("#dialog_changebackground").dialog({title:"Change Background",autoOpen:!0,modal:!0,buttons:{"Change Background":function(){return window.there_upload_pic?(window.settingapp.background_change(),a(this).dialog("close")):alert("Load an image or wait for image to complete loading")}}})},background_change:function(){var b;return b=BackgroundImage.first(),b.image=window.imageevent.target.result,b.save(),a("#bghelp")[0].style.background="url("+BackgroundImage.first().image+") no-repeat center"},setting_window:function(){return a("#dialog").dialog({modal:!0,title:"Settings for sync",buttons:{"Validate Code":function(){return window.settingapp.validate_code(),a(this).dialog("close")}}})},show_help:function(){return a("#dialog_help").dialog({modal:!0,title:"Help Tips"})},open_validation_window:function(){return window.open("https://accounts.google.com/o/oauth2/auth?scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Ftasks&redirect_uri=urn:ietf:wg:oauth:2.0:oob&response_type=code&client_id=784374432524.apps.googleusercontent.com")},validate_code:function(){var b,c;return c=new XMLHttpRequest,b=a("#auth_submit").serialize(),c.open("POST","https://accounts.google.com/o/oauth2/token"),c.onreadystatechange=function(b,d){var e,f;if(c.readyState===4)return window.obj=a.parseJSON(window.xhr.response),gapi.auth.setToken(window.obj),gapi.client.load("tasks","v1",function(){return console.log("api loaded")}),e=Token.first(),e.current_token=window.obj.access_token,f=moment().add("seconds",window.obj.expires_in),e.expiration=f.toString(),e.refresh_token=window.obj.refresh_token,e.save(),create("default",{title:"Validation succeeded",text:"Your list will now auto sync"}),initialize_and_sync_list()},c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.send(b),window.xhr=c,a("#dialog").dialog("close")},setup_api_on_entry:function(b){var c,d,e,f,g;return Token.first().refresh_token===""?(a("#syncbutton")[0].src="images/02-redo@2x.png",!0):(c=Token.first(),e=moment(c.expiration),f=moment(),f<e?(console.log("token not expired"),gapi.auth.setToken({access_token:c.current_token,expires_in:3600,token_type:"Bearer"}),gapi.client.load("tasks","v1",function(){return console.log("api loaded"),b()})):(console.log("token expired"),g=new XMLHttpRequest,c=Token.first(),
window.refresh=c.refresh_token,d="client_id=784374432524.apps.googleusercontent.com&client_secret=u4K1AZXSj8P9hIlEddLsMi6d&refresh_token="+window.refresh+"&grant_type=refresh_token",window.data=d,g.open("POST","https://accounts.google.com/o/oauth2/token"),g.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),g.onreadystatechange=function(d,e){if(g.readyState===4)return window.obj=a.parseJSON(window.xhr.response),gapi.auth.setToken(window.obj),gapi.client.load("tasks","v1",function(){return console.log("api loaded"),b()}),c=Token.first(),c.current_token=window.obj.access_token,f=moment().add("seconds",window.obj.expires_in),c.expiration=f.toString(),c.save()},g.send(d),window.xhr=g))}}),window.settingapp=SettingApp.init({el:"#theapp"})}),window.rendering_cal=function(){var a,b;return b=Task.select(function(a){return a.duedate!==void 0}),a=[],$.each(b,function(b,c){return a.push({title:c.name,start:new Date(c.duedate)})}),$("#calendar").fullCalendar("renderEvent",a,!1)},window.rendering_cal_process=function(a,b,c){var d,e,f,g,h,i;e=Task.select(function(a){return a.duedate!==void 0}),g=Finished.all(),d=[],$.each(e,function(a,b){return d.push({title:b.name,start:new Date(b.duedate),className:"current_task"})});for(h=0,i=g.length;h<i;h++)f=g[h],d.push({title:f.name,start:new Date(f.time_finished),className:"finished_task"});return $("#calendar").fullCalendar("renderEvent",d,!1),c(d)},window.initializeApp=function(){var a,b,c,d,e,f,g;Initialized.all().length===0&&(delete localStorage.Task,e=Version.init({number:"2.0"}),e.save(),g=Initialized.init({flag:"true"}),g.save(),f=List.init({name:"Your Todos",description:"",time:moment().toString(),synced:!1}),f.id="@default",f.save(),b=Task.init({name:"Click on settings and link your gtask account",time:moment().toString(),done:!1,order:Task.all().length+1,synced:!1,listid:"@default"}),c=Task.init({name:"Click on sync to get the tasks in your current google account",time:moment().toString(),done:!1,order:Task.all().length+1,synced:!1,listid:"@default"}),b.save(),c.save(),d=Token.init({current_token:"",expiration:"",refresh_token:""}),d.save(),a=BackgroundImage.init({image:""}),a.save());if(Version.first().number==="0.2")return d=Token.init({current_token:"",expiration:"",refresh_token:""}),d.save(),a=BackgroundImage.init({image:""}),a.save()},window.myErrorHandler=function(a,b,c){var d,e,f;return e=a+" "+b+" "+c+" "+navigator.userAgent,e=encodeURIComponent(e),f=new XMLHttpRequest,f.open("POST","https://docs.google.com/spreadsheet/formResponse"),f.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),f.onreadystatechange=function(a,b){},f.readyState===4&&(window.obj=$.parseJSON(window.xhr.response)),d="formkey=dExjNVkwM1JkQm1oYy1BMGRKVjlUaVE6MQ&entry.0.single="+e+"&hl=en_US",console.log(d),f.send(d)},window.onerror=window.myErrorHandler,Task.fetch(),Deletion.fetch(),List.fetch(),Token.fetch(),Finished.fetch(),Initialized.fetch(),Version.fetch(),BackgroundImage.fetch(),initializeApp(),setting_url="",window.last_opened="",window.cur=0,window.taskdict={},window.obj=null,$(function(){return BackgroundImage.first().image!==""&&($("#bghelp")[0].style.background="url("+BackgroundImage.first().image+") no-repeat center"),$("#newtaskdate").datepicker({constrainInput:!0,buttonImage:"famfamicons/calendar.png",buttonImageOnly:!0,buttonText:"",showOn:"both",onSelect:function(a,b){if($(this).parent().parent().find(".showdate").length===1)return $(this).parent().parent().find(".showdate").html(a)}}),window.container=$("#container").notify(),$("#calendar").fullCalendar({events:window.rendering_cal_process}),$("#calendarview").hide(),updateItems(),shortcut.add("up",prevItem),shortcut.add("down",nextItem),shortcut.add("enter",open_for_edit,{disable_in_input:"true"}),shortcut.add("backspace",pressed_delete,{disable_in_input:"true"}),shortcut.add("delete",pressed_delete,{disable_in_input:"true"})}),window.create=function(a,b,c){return window.container.notify("create",a,b,c)},window.addlist_window=function(){return $("#list_name").val(""),$("#list_description").val(""),$("#dialog_addlist").dialog({modal:!0,title:"Add A New List",dialogClass:"adding",buttons:{"Add List":function(){return add_list(),$(this).dialog("close")}}})},window.add_list=function(){var a,b,c;return b=$("#list_name").val(),a=$("#list_description").val(),navigator.onLine?(c=List.init({name:b,description:a,time:(new Date).getTime().toString(),synced:!0}),c.save(),window.settingapp.setup_api_on_entry(function(){return List.add_to_cloud(c,function(a){return window.App.render_new(a),$("#syncbutton")[0].src="images/02-redo@2x.png"})})):(c=List.init({name:b,description:a,time:(new Date).getTime().toString(),synced:!1}),c.save()),window.App.render_new(c),$("#dialog_addlist").dialog("close")},window.edit_list=function(){var a;return a=List.find($("#dialog_addlist").data("id")),a.name=$("#list_name").val(),a.description=$("#list_description").val(),a.time=(new Date).getTime().toString(),navigator.onLine?(a.updated=!0,a.save(),window.settingapp.setup_api_on_entry(function(){return List.update_to_cloud(a,function(a){return $("#syncbutton")[0].src="images/02-redo@2x.png"})})):(a.updated=!1,a.save()),$("#dialog_addlist").dialog("close")},window.toggle=function(a,b,c,d){return $(a).hide(),$(b).show(),$(c).removeClass("active"),$(d).addClass("active"),$("#calendar").fullCalendar("refetchEvents"),$("#calendar").fullCalendar("windowResize")},window.show_all_div=function(){return $(".listdiv").show(),$(".filterselected").removeClass("filterselected"),$("#allbutton").addClass("filterselected")},typeof Titanium!="undefined"&&Titanium!==null&&(ti_window=Titanium.UI.currentWindow,ti_window.height=510),nextItem=function(){return $("textarea:focus").length===0&&$("input:focus").length===0&&(cur<$("li").length-1?window.cur++:window.cur=0,updateItems()),!0},prevItem=function(){return $("textarea:focus").length===0&&$("input:focus").length===0&&(cur>0?window.cur--:window.cur=$("li").length-1,updateItems()),!0},updateItems=function(){return $("li.task_selected").removeClass("task_selected"),$("li:eq("+cur+")").addClass("task_selected")},open_for_edit=function(){var a,b;return $("textarea:focus").length===0&&$("input:focus").length===0&&(a=Task.find($(".task_selected").data("id")),b=window.taskdict[$(".task_selected").data("id")],b.edit()),!0},pressed_delete=function(){var a,b,c;b=confirm("Are you sure you want to delete this task?");if($("textarea:focus").length===0&&$("input:focus").length===0&&b)return a=Task.find($(".task_selected").data("id")),c=window.taskdict[$(".task_selected").data("id")],c.destroy()},make_child=function(){var a,b;alert("make child"),a=Task.find($(".task_selected").data("id")),b=window.taskdict[$(".task_selected").data("id")];if(b.el.index()===0){alert("The first task cannot be made into a child");return}return b.el.addClass("child_1")},exports=this,this.nextItem=nextItem,this.prevItem=prevItem,this.updateItems=updateItems,this.open_for_edit=open_for_edit,this.pressed_delete=pressed_delete,this.make_child=make_child})).call(this);